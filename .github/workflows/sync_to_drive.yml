name: Sync to Google Drive
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare credentials
        id: prepare
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          set -e
          # Intento de aceptar tanto secret en base64 como JSON crudo.
          # Si es base64 válido lo decodificamos; si no, lo tratamos como JSON crudo.
          if echo "$GCP_SA_KEY" | base64 --decode >/dev/null 2>&1; then
            echo "Credentials appear to be base64-encoded. Decoding..."
            echo "$GCP_SA_KEY" | base64 --decode > credentials.json
          else
            echo "Credentials do not appear to be base64. Treating as raw JSON."
            echo "$GCP_SA_KEY" > credentials.json
          fi
          # Re-encode a base64 sin saltos para pasar a la acción que espera base64
          CREDENTIALS_B64=$(cat credentials.json | base64 -w 0)
          echo "credentials_b64=$CREDENTIALS_B64" >> $GITHUB_OUTPUT

      - name: Sync to Drive
        uses: mathisve/gdrive-upload-action@main #en ocasiones hay que usar otro repo
        with:
          credentials: ${{ steps.prepare.outputs.credentials_b64 }}
          filename: src/ # Carpeta que quieres subir
          folderId: 1GRhqBkbs3mk_WVRvDN40boI1AYHlt0RF
          overwrite: "true"
          # Revisar bien el JSON del secret
